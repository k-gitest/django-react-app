name: PR Quality Check

on:
  pull_request:
    branches:
      - main
      - develop

jobs:
  commit-message:
    name: Check Commit Messages
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Validate commit messages
        run: |
          echo "Checking commit messages format..."
          
          # Get all commits in this PR
          COMMITS=$(git log --format=%s origin/${{ github.base_ref }}..${{ github.event.pull_request.head.sha }})
          
          # Check each commit
          echo "$COMMITS" | while read -r message; do
            if ! echo "$message" | grep -qE '^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .+'; then
              echo "âŒ Invalid commit message: $message"
              echo ""
              echo "Commit messages must follow Conventional Commits format:"
              echo "  type(scope?): subject"
              echo ""
              echo "Types: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert"
              echo "Example: feat(auth): add login functionality"
              exit 1
            fi
          done
          
          echo "âœ… All commit messages are valid"

  file-size:
    name: Check File Sizes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for large files
        run: |
          echo "Checking for files larger than 5MB..."
          
          LARGE_FILES=$(find . -type f -size +5M \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./.venv/*" \
            -not -path "./backend/.venv/*" \
            -not -path "./.terraform/*")
          
          if [ -n "$LARGE_FILES" ]; then
            echo "âŒ Large files detected (>5MB):"
            echo "$LARGE_FILES"
            echo ""
            echo "Please use Git LFS for large files or remove them."
            exit 1
          fi
          
          echo "âœ… No large files detected"

  secret-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for potential secrets
        run: |
          echo "Scanning for potential secrets..."
          
          # Patterns to search for (å®Ÿéš›ã®å€¤ã®ã¿ã‚’æ¤œå‡º)
          PATTERNS=(
            "['\"]([A-Za-z0-9]{20,})['\"]"  # é•·ã„è‹±æ•°å­—æ–‡å­—åˆ—
            "ghp_[A-Za-z0-9]{36}"           # GitHub Personal Access Token
            "ghs_[A-Za-z0-9]{36}"           # GitHub OAuth Secret
            "sk-[A-Za-z0-9]{48}"            # OpenAI API Key
            "AIza[A-Za-z0-9_-]{35}"         # Google API Key
          )
          
          # é™¤å¤–ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
          EXCLUDE_PATTERNS=(
            "test"
            "example"
            "\.md$"
            "\.yml$"
            "\.tf$"
            "SKILL\.md"
            "README"
          )
          
          # Files to search
          FILES=$(find . -type f \
            \( -name "*.py" -o -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" -o -name "*.env" \) \
            -not -path "./.git/*" \
            -not -path "./node_modules/*" \
            -not -path "./.venv/*" \
            -not -path "./backend/.venv/*" \
            -not -path "./.terraform/*" \
            -not -path "*test*" \
            -not -path "*example*")
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(echo "$FILES" | xargs grep -E "$pattern" 2>/dev/null | grep -v "^#" || true)
            if [ -n "$MATCHES" ]; then
              # ã•ã‚‰ã«é™¤å¤–ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ãƒ•ã‚£ãƒ«ã‚¿
              FILTERED=$(echo "$MATCHES" | grep -v -E "$(IFS="|"; echo "${EXCLUDE_PATTERNS[*]}")" || true)
              if [ -n "$FILTERED" ]; then
                echo "âš ï¸  Potential secret found:"
                echo "$FILTERED"
                FOUND=1
              fi
            fi
          done
          
          if [ $FOUND -eq 1 ]; then
            echo ""
            echo "Please review the findings above and ensure no real secrets are committed."
            exit 1
          fi
          
          echo "âœ… No potential secrets detected"

  pr-summary:
    name: PR Summary
    runs-on: ubuntu-latest
    needs: [commit-message, file-size, secret-scan]
    if: always()
    
    steps:
      - name: Create PR Summary
        run: |
          echo "## ðŸ“‹ PR Quality Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.commit-message.result }}" == "success" ]; then
            echo "- âœ… Commit messages follow Conventional Commits" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Commit messages validation failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.file-size.result }}" == "success" ]; then
            echo "- âœ… No large files detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Large files detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.secret-scan.result }}" == "success" ]; then
            echo "- âœ… No secrets detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸  Potential secrets detected - please review" >> $GITHUB_STEP_SUMMARY
          fi